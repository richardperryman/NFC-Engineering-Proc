<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script type="text/javascript">
		var key;
		var userId;
		
		if(localStorage.key){
			key = localStorage.key;
		}
		if(localStorage.userId){
			userId = localStorage.userId;
		}
		
		function login(){
			var username = $('#username').val();
			var password = $('#password').val();
			var obj = {username:username,password:password};
			
			$.post({
				url : '/login',
				data : JSON.stringify(obj),
				dataType : 'json',
				success : loginSuccess
			});
			
			console.log('Logging in with: ' + username + ':' + password);
		}
		
		function loginSuccess(data){
			console.log('Log in response: ' + data.key.data.toString());
			key = data.key.data;
			userId = data.user;
			if(typeof(Storage) !== undefined){
				localStorage.setItem('key',key);
				localStorage.setItem('userId',userId);
			}
		}
		
		function getRegistrations(){
			if(userId == undefined){
				return;
			}
			// Make request to access/management endpoint
			var query = '?user_id=' + userId;
			$.get({
				url : ('/access/management' + query),
				dataType : 'json',
				success : getRegSuccess,
				headers : {'hmac-user':'10outta13'}
			});
		}
		
		function getRegSuccess(data){
			// Show the reg table and hide the login section
			$('#login').hide();
			$('#registrations').show();
			// Build and display the registrations
			var regs = [];
			for(var i=0;i<data.length;i++){
				regs[i] = {regId:data[i]['Reg_Id'],lockId:data[i]['Lock_Id'],identityId:data[i]['Identity_Id']};
				displayRegistration(regs[i]);
			}
		}
		
		function displayRegistration(reg){
			// Build the tr
			var row = '<tr><td>' + reg.regId + '</td><td>' + reg.lockId + '</td><td>'
				+ reg.identityId + '</td></tr>';
			// Append the tr to table (#registrations table)
			$('#registrations table').append(row);
		}
		
		function setHeaders(request,body){
			request.setRequestHeader('hmac-user','10outta13');
		}
	</script>
	
	<title>SBACS Login</title>
</head>
<body>
	<!-- Login information. On get registrations, hide this part -->
	<div id="login">
		<form>
			Username: 
			<input id="username" type="text"/>
			<br/>
			Password: 
			<input id="password" type="password"/>
			<br/>
			<input type="button" value="Login" onclick="login();"/>
			<input type="button" value="Get Registrations" onclick="getRegistrations()"/>
		</form>
	</div>
	
	<!-- Registrations information. On start, hide this part 
		Show it after selecting get registration-->
	<div id="registrations" hidden="true">
		<table>
			<tr><th>Registration Id</th><th>Lock Id</th><th>Identity Id</th></tr>
			
		</table>
	</div>
</body>
</html>